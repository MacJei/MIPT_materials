## Системы ведения очередей задач пользователей на вычислительном кластере. Политики системных администраторов, алгоритмы управления очередями заданий (Gang, Backfill и др.).

Файл-паспорт задачи — обычный txt-документ, описывающий множество ресурсов, которое потребует задача.

Рассмотрим систему PBS (Portable Batch System). Есть shell-скрипт, в котором заводим псевдо-комментарии следующего вида:
```shell
#PBS <описание ресурса>
```

Наиболее популярные ресурсы:
* число процессоров и узлов необходимых для выполнения наших задач;
* время (можно не указывать, тогда установится самостоятельно исходя из своих соображений), например, 4 дня. Через это время PBS убьет все процессы, порожденные под эту задачу;
* оперативная память на узле;
* лицензии коммерческого программного обеспечения;
* оборудование, установленное на кластере (например, узлы с графическими ускорителями);
* само имя узла (хотим запускать задача именно с этим именем).

Другие системы: OpenPBS, Moab (коммерческий планироващик), SLURM (Simple Linux Utility for Resource Management) (наиболее популярный), IBM LoadLeveler, SunGrid Engine (устаревшая).

Рассмотрим SLURM.
* Компоненты системы ведения очередей:
  * демон-контролер (проверяет права на использование ресурсов);
  * демон-пускач (строит дерево процессов);
  * демон ведегния очереди (если очередь сложна, он же планировщик заданий);
  * клиент.
* Клиентские программы для взаимодействия с сервром-контролером:
  * `sbatch` — ставит в очередь shell-скрипт, не предполагает никакой интерактивности;
  * `srun` — в отличие от `sbatch`, не блокирет консоль до запуска скрипта;
  * `sinfo` — информация о состоянии кластера;
  * `squeue` — инфоромация о состоянии очереди;
  * `scancel` — убирает задачу из очереди (если не была запущена) либо прекращает ее выполнение (если была);
  * `scontrol` — выяснить, какие именно узлы выданы задаче;
  * `smap` — в графическом виде показывает множество свободных и занятых узлов.
* Серверная часть:
  * `slurmctld` — контрольный демон, следящий за ресурсками и распределяющих их между задачами;
  * `slurmdbd` — занимается удаление и добавление процессов в базе данных;
  * `slurmd` — есть в каждом вычислительном узле, он управляет узлом, в котором запущен (в том числе мониторинг выполняющихся заданий, получение заданий от контролера, распределение задач по ядрам на узле и остановка заданий по запросу контролера).

Алгоритмы управления очередями заданий:

* FIFO — обычная очередь, обработка задач  в порядке поступления.
  * Преимущества: реально справедливый алгоритм.
  * Недостатки:
    * может заблокироваться;
    * неоптимальное использование ресурсов (задачи не пропускает, не гарантирует полноту загруженности кластера);
    * несправедлива к маленьким задачам, так как они будут ждать столько же, сколько и большие;

  Как частичное улучшение рассматривают очередь с приоритетами.

* Gang — есть несколько очередей с разными приоритетами, каждая очередь связаны с разным количеством ресурсов. Переходим по очередям по кругу. В рамках одной конерктной задачи очереди здесь используют FIFO. Используя эту технику, можно добиться хороших результатов.

* Backfill — алгоритм обратного заполнения. Принцип достаточно простой: каждая задача ставится в минимально возможный по число доступных ресурсов период времени с учетом тех задач, что уже поставлены.

  Идея в том, что вычислительная система представляет собой стакан, а дно — многомерная поверхность, за которой скрывается множество ресурсов. Время растет вертикально, процессоры горизонтально. Наша задача — «сыграть в тетрис».

  В общем, задача ставится параллельно как можно ниже. Но если нельзя параллельно, то делается новый слой (только здесь мы можем опускать ниже занятых слоев, если есть место на нижних). Пример:

  ```txt
  #          #
  #6666      #
  #4444444444#
  #2222255   #
  #111111333 #
  ############
  ```

  Это работает намного лучше, чем FIFO. Кроме того, здесь мы можем управлять приоритетом поступления задач. Если на одно окно две задачи с разным приоритетом, то в более ранее окно пойдет та задача, у которой приоритет выше (окно — промежуток (time, resources), который может быть захвачен).
