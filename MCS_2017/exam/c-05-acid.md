## ACID. Степени изоляции транзакций.

Базы данных, не обязательно распределенные, обычно имеют более одного клиента. Так или иначе, эти клиенты конкурируют за доступ к базе.

Клиент работает с базой данных, выполняя операции, которые группируются в транзакции.

База данных должны давать клиентам гарантии, описывающие, как они будут влиять друг на друга.

_ACID_ — наиболее популярный станларт баз данных, определяющий 4 свойства:
* **atomicuty** (атомарность) — гарантирует, что либо все операции когда-то будут применены, либо ни одна не будет. На это не должны влять даже отказы, потеря питания или ошибки выполнения;
* **conistency** (согласованность) — гарантирует, что результатом транзакции будет корректное состоянии базы данных, то есть будут соблюдены правила базы данных, такие как целостность и пр.;
* **isolation** (изолированность) — гарантирует, что конкурентное выполнение транзакций приведет базу данных в состоняние, идентичное последовательному их применению;
* **durability** (устойчивость) — гарантирует, что примененная транзакция останется в истории базы данных навсегда.

_Замечания_.
* Вопросы, которые вызывают эти определния:
  * когда другие клиенты увидят результат транзакции?
  * увижу ли я сразу результат своей транзакции?
  * будет ли порядок для разных клиентов одинаковым?
  * когда записи транзакции увидят другие клиенты?
  * увижу ли я собственные незакомиченные записи?
* Consistency из ACID совсем не то же, что Consistency в CAP.

## Степени изоляции транзакций

Уровни изоляции принято описывать через наборы всевозможных влияений параллельных транзакций.

Уровень \ Влияние | Dirty Reads | Non-Repeatable Reads | Phantoms
----------------- | ----------- | -------------------- | --------
Read Uncommited   | возможно    | возможно             | возможно
Read Commited     | нет         | возможно             | возможно
Repeatable Read   | нет         | нет                  | возможно
Serializable      | нет         | нет                  | нет

Рассмотрим на примере транзакции 1 и транзакции 2.

* Dirty Reads — чтение может вернуть изменения, вызванные транзакцией, которая впоследствии не подтвердится.

  ```SQL
  /* 1 */ SELECT age FROM users WHERE id = 1; -- Прочитает 20.
  /* 2 */ UPDATE users SET age = 21 WHERE id = 1; -- Впоследствии не подтвердится.
  /* 1 */ SELECT age FROM users WHERE id = 1; -- Прочитает 21.
  ```

* Non-Repeatable Reads — повторное чтение может вернуть другое состояние строки.

  ```SQL
  /* 1 */ SELECT * FROM users WHERE id = 1; -- Прочитает одно.
  /* 2 */ UPDATE users SET age = 21 WHERE id = 1;
  /* 2 */ COMMIT;
  /* 1 */ SELECT * FROM users WHERE id = 1; -- Прочитает другое в той же транзакции.
  ```

* Phantoms — два идентичных запроса возвращают разный набор строк.

  ```SQL
  /* 1 */ SELECT * FROM users WHERE age BETWEEN 10 AND 30; -- Вернет одни строки.
  /* 2 */ INSERT INTO users(id,name,age) VALUES ( 3, 'Bob', 27 ); -- Добавит еще строки.
  /* 2 */ COMMIT;
  /* 1 */ SELECT * FROM users WHERE age BETWEEN 10 AND 30; -- Вернет еще и новую строку в той же транзакции.
  /* 1 */ COMMIT;
  ```
